<!DOCTYPE html>
<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    
    
 <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script type="text/javascript" src="https://vk.com/js/api/openapi.js?169"></script> 
    
    
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
	<title>Ваш сайт</title>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script type="text/javascript" src="https://vk.com/js/api/openapi.js?169"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://www.google.com/jsapi"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://kaboomjs.com/lib/0.5.0/kaboom.js"></script> 
    
    
    
    
    
    
    
    <style>
        
        
  
    </style>
</head>
	
	
<script>
vkBridge.send('VKWebAppInit');
</script>
	
	

<body>
     <div class="d-flex justify-content-center"> 
	     <br><br><br><br>
    <h1>Подключение к WhatsApp</h1>
</div> 
 
    
       <div class="d-flex justify-content-center">  
    
    <form>
        <label for="idInstance">Секретный ключ:</label><br>
        <input required type="text" id="idInstance" name="idInstance"><br><br>
        <label for="apiTokenIsntance">API Токен:</label><br>
        <input required type="text" id="apiTokenIsntance" name="apiTokenIsntance"><br>
    </form>
</div> 

    
    <div class="d-flex justify-content-center">  
    <p style="color:blue" id="statusText"></p>
    </div>     
    <div class="d-flex justify-content-center">    
    <p style="color:blue" id="resultText"></p>
    </div>      
	    
    <div class="d-flex justify-content-center">     
    <p>Нажмите кнопку для авторизации</p>
    </div> 
	
<div class="d-flex justify-content-center">        

	    
        <button id="getQrBtn" type="button" class="btn btn-success btn-lg">Получить QR код</button>
	 </div>
	
	 <div class="d-flex justify-content-center">   
        <button style="display: none" hidden id="logoutQrBtn" type="button" class="btn btn-success btn-lg">Отключить</button>
	</div>	 
	
	 <div class="d-flex justify-content-center"> 	 
        <img hidden id="img-qr-code" alt="QR-Code" class="sb-qr-wizard-qr-code" aria-hidden="false" src="data:image/png;base64,%QR_DATA%" style="">
    </div>
   
    
    <script type="text/javascript" src="https://unpkg.com/@green-api/whatsapp-api-client/lib/whatsapp-api-client.min.js"></script>
    <script>
        var intervalId = null
        const qrCodeElement = document.getElementById("img-qr-code")
        const qrTempalte = qrCodeElement.getAttribute('src');
        
        document.getElementById("getQrBtn").addEventListener("click", function () {
            try {
                isAuthed();
                clearInterval(intervalId)
                updateQRCode()
                intervalId = setInterval(updateQRCode, 5000);
                
            } catch (reason) {
                console.error(reason);
                document.getElementById("resultText").innerHTML = reason + ". See logs for details";
            }
        });

        document.getElementById("logoutQrBtn").addEventListener("click", function () {
            try {
                const restAPI = whatsAppClient.restAPI(({
                    idInstance: document.getElementById("idInstance").value,
                    apiTokenInstance: document.getElementById("apiTokenIsntance").value
                }))
                
                restAPI.instance.logout()
                    .then((data) => {
                        document.getElementById("resultText").innerHTML = "isLogout=" + data.isLogout
                        isAuthed();
                    }).catch((reason) => {
                        console.error(reason);
                        document.getElementById("resultText").innerHTML = reason + ". See logs for details";
                    });
            } catch (reason) {
                console.error(reason);
                document.getElementById("resultText").innerHTML = reason + ". See logs for details";
            }
        });

        function updateQRCode() {
            const restAPI = whatsAppClient.restAPI(({
                idInstance: document.getElementById("idInstance").value,
                apiTokenInstance: document.getElementById("apiTokenIsntance").value
            }))
            restAPI.instance.qr()
                .then((data) => {
                    console.log(data);
                    document.getElementById("resultText").innerHTML = "";
                    if (data.type === 'qrCode') {
                        qrCodeElement.hidden = false;
                        qrCodeElement.setAttribute('src', qrTempalte.replace("%QR_DATA%", data.message))
                    } else {
                        qrCodeElement.hidden = true;
                        clearInterval(intervalId)
                        isAuthed();
                        document.getElementById("resultText").innerHTML = data.message
                    }
                }).catch((reason) => {
                    console.error(reason);
                    document.getElementById("resultText").innerHTML = reason + ". See logs for details";
                });
        }

        function isAuthed() {
            const restAPI = whatsAppClient.restAPI(({
                    idInstance: document.getElementById("idInstance").value,
                    apiTokenInstance: document.getElementById("apiTokenIsntance").value
                }))
            restAPI.instance.getStateInstance().then(data => {
                document.getElementById("statusText").innerHTML = data.stateInstance;
                
                if (data.stateInstance === 'authorized') {
                    document.getElementById("getQrBtn").style.display = "none"
                    document.getElementById("logoutQrBtn").style.display = "block"
                } else {
                    document.getElementById("getQrBtn").style.display = "block"
                    document.getElementById("logoutQrBtn").style.display = "none"
                }
                 
                
            })
        }
    </script>

</body>

</html>
